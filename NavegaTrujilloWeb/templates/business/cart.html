{% extends 'base_template.html' %}
{% load static %}

{% block main %}

<script>
function addCookieItem(shipId, action){
	console.log('User is not authenticated')

	if (action == 'add'){
		if (cart[shipId] == undefined){
		cart[shipId] = {'quantity':1}

		}else{
			cart[shipId]['quantity'] += 1
		}
	}

	if (action == 'remove'){
		cart[shipId]['quantity'] -= 1

		if (cart[shipId]['quantity'] <= 0){
			console.log('Item should be deleted')
			delete cart[shipId];
		}
	}
	console.log('CART:', cart)
	document.cookie ='cart=' + JSON.stringify(cart) + ";domain=;path=/"
	location.reload()
}

function updateCaptainAmount(action){
    let captainAmount = parseInt(document.getElementById("captain-amount").innerText);
    
    if (action == 'increase'){
        captainAmount += 1;
    } else if (action == 'decrease' && captainAmount > 0){
        captainAmount -= 1;
    }
    
    // Update the cookie with the new captain amount
    cart['captain_amount'] = captainAmount;
    document.cookie = 'cart=' + JSON.stringify(cart) + ";domain=;path=/"
    document.getElementById("captain-amount").innerText = captainAmount;
    location.reload();
}

function redirect_reservation(){
	window.location.href="reserva";
}
</script>

<link rel="stylesheet" href="{% static 'css/carrito.css' %}">
<div class="cart-page">
    <div class="header-cart">
        <h2>Tu carrito</h2>
    </div>

    {% if cartItems > 0 %}
        <div class="captain-info">
            <p>Capitanes: <span id="captain-amount">{{ order.captain_amount }}</span></p>
        </div>
        <div class="captain-controls">
            <button class="button-cart" onclick="updateCaptainAmount('increase')">Aumentar Capitán</button>
            <button class="button-cart" onclick="updateCaptainAmount('decrease')">Disminuir Capitán</button>
        </div>
        <div class="captain-info">
            <p>Coste de Capitanes: ${{ order.captain_cost }}</p>
        </div>

        <p>Tienes {{ cartItems }} artículo(s) en tu carrito.</p>

        <div class="body-cart">
            <table class="table-cart">
                <thead>
                    <tr>
                        <th>Nombre del Barco</th>
                        <th>Puerto</th>
                        <th>Capacidad</th>
                        <th>Precio por Día</th>
                        <th>Cantidad</th>
                        <th>Total</th>
                        <th>Ajustar cantidad</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    {% if item.quantity > 0 %}
                    <tr>
                        <td>{{ item.ship.name }}</td>
                        <td>{{ item.ship.port.ubication }}</td>
                        <td>{{ item.ship.capacity }}</td>
                        <td>${{ item.ship.rent_per_day }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>${{ item.get_total }}</td>
                        <td> 
                            {% if item.quantity > 0 %}
                                <button class="button-cart" onclick="addCookieItem('{{ item.ship.id }}', 'add')">+</button>
                                <button class="button-cart" onclick="addCookieItem('{{ item.ship.id }}', 'remove')">-</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>

            <p>Total del carrito (incluyendo capitanes): ${{ order.total_with_captain }}</p>
            <button class="button-cart" onclick="redirect_reservation()">Reservar</button>
        </div>
    {% else %}
        <div class="body-cart">
            <p>No tienes barcos en tu carrito.</p>
        </div>
    {% endif %}

</div>
{% endblock %}
